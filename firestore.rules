rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * BANK FOOD ORDERING SYSTEM - SECURITY RULES
     */

    function isSignedIn() {
      return request.auth != null;
    }

    // Retrieves the current user's profile data safely
    function getEmployeeData() {
      let path = /databases/$(database)/documents/employees/$(request.auth.uid);
      return exists(path) ? get(path).data : null;
    }

    function hasRole(role) {
      let data = getEmployeeData();
      return isSignedIn() && data != null && data.role == role;
    }

    function isSuperAdmin() {
      return hasRole('Admin');
    }

    function isSupervisor() {
      return hasRole('Supervisor');
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // --- COLLECTION RULES ---

    // Branches & Departments: Public list/get for navigation
    match /branches/{branchId} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }

    match /departments/{departmentId} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }

    // Menu: Public list/get for ordering
    match /menu_items/{menuItemId} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }

    // Employees: Public list/get for selection and rotation visibility
    match /employees/{employeeId} {
      allow read: if true;
      allow create: if isSuperAdmin();
      allow update: if isSuperAdmin() || isOwner(employeeId) || (isSupervisor() && getEmployeeData().departmentId == resource.data.departmentId);
      allow delete: if isSuperAdmin();
    }

    // Orders: Publicly readable for tracking, anyone can create (anonymous auth)
    match /orders/{orderId} {
      allow read: if true;
      allow create: if true;
      allow update: if isSuperAdmin() || isSupervisor() || (isSignedIn() && request.auth.uid == resource.data.employeeId);
      allow delete: if isSuperAdmin();
    }

    match /_config_/{configId} {
      allow read, write: if false;
    }
  }
}