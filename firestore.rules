rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * BANK FOOD ORDERING SYSTEM - SECURITY RULES
     * Deployment Trigger: 2024-05-20 15:00:00
     * Fixed: Standardized read permissions for employees and departments to support collection-wide queries.
     */

    function isSignedIn() {
      return request.auth != null;
    }

    // Safely retrieves the current user's profile data
    function getEmployeeData() {
      let path = /databases/$(database)/documents/employees/$(request.auth.uid);
      return isSignedIn() && exists(path) ? get(path).data : null;
    }

    function hasRole(role) {
      let data = getEmployeeData();
      return isSignedIn() && data != null && data.role == role;
    }

    function isSuperAdmin() {
      return hasRole('Admin');
    }

    function isSupervisor() {
      return hasRole('Supervisor');
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // --- COLLECTION RULES ---

    // Branches & Departments: Publicly readable for navigation
    match /branches/{branchId} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }

    match /departments/{departmentId} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }

    // Menu Items: Publicly readable for ordering
    match /menu_items/{menuItemId} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }

    // Employees: Public read is REQUIRED for the selection dropdown and rotation engine.
    match /employees/{employeeId} {
      allow read: if true;
      allow create: if isSuperAdmin();
      allow update: if isSuperAdmin() || isOwner(employeeId) || (isSupervisor() && getEmployeeData().departmentId == resource.data.departmentId);
      allow delete: if isSuperAdmin();
    }

    // Orders: Publicly readable for tracking, anyone can create (requires anonymous auth for context)
    match /orders/{orderId} {
      allow read: if true;
      allow create: if isSignedIn();
      allow update: if isSuperAdmin() || isSupervisor() || (isSignedIn() && request.auth.uid == resource.data.employeeId);
      allow delete: if isSuperAdmin();
    }

    // Internal configuration
    match /_config_/{configId} {
      allow read, write: if false;
    }
  }
}