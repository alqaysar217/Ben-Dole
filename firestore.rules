rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * BANK FOOD ORDERING SYSTEM - SECURITY RULES
     */

    function isSignedIn() {
      return request.auth != null;
    }

    // Retrieves the current user's profile data safely
    function getEmployeeData() {
      let path = /databases/$(database)/documents/employees/$(request.auth.uid);
      return exists(path) ? get(path).data : null;
    }

    function hasRole(role) {
      let data = getEmployeeData();
      return isSignedIn() && data != null && data.role == role;
    }

    function isSuperAdmin() {
      return hasRole('Admin');
    }

    function isSupervisor() {
      return hasRole('Supervisor');
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // --- COLLECTION RULES ---

    match /branches/{branchId} {
      allow get, list: if true;
      allow write: if isSuperAdmin();
    }

    match /departments/{departmentId} {
      allow get, list: if true;
      allow write: if isSuperAdmin();
    }

    match /menu_items/{menuItemId} {
      allow get, list: if true;
      allow write: if isSuperAdmin();
    }

    match /employees/{employeeId} {
      // Allow public list/get for the employee selection dropdown and rotation status
      allow get, list: if true;
      allow create: if isSuperAdmin();
      allow update: if isSuperAdmin() || isOwner(employeeId) || (isSupervisor() && getEmployeeData().departmentId == resource.data.departmentId);
      allow delete: if isSuperAdmin();
    }

    match /orders/{orderId} {
      // Allow reading orders for status tracking and supervisor summaries
      allow read: if true;
      
      // Allow anyone to create an order (satisfies "no password required" for employees)
      allow create: if true;

      // Allow supervisors and admins to update order status
      allow update: if isSuperAdmin() || isSupervisor() || (isSignedIn() && request.auth.uid == resource.data.employeeId);

      allow delete: if isSuperAdmin();
    }

    match /_config_/{configId} {
      allow read, write: if false;
    }
  }
}